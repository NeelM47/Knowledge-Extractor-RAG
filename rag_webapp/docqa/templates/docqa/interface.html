<!-- docqa/templates/docqa/interface.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Knowledge Extractor RAG</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome for Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <style>
        body {
            background-color: #f0f2f5;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
        }
        .main-container {
            display: flex;
            gap: 2rem;
            padding: 2rem;
            max-width: 1400px;
            margin: auto;
        }
        .control-panel {
            flex: 0 0 380px;
        }
        .chat-container {
            flex-grow: 1;
        }
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.08);
            margin-bottom: 2rem;
        }
        .card-header {
            background-color: #ffffff;
            border-bottom: 1px solid #e9ecef;
            font-weight: 600;
            font-size: 1.1rem;
            padding: 1rem 1.5rem;
        }
        .card-body {
            padding: 1.5rem;
        }
        h1 {
            font-weight: 700;
            color: #333;
        }
        #chat-box {
            height: 60vh;
            overflow-y: auto;
            background-color: #ffffff;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 1rem;
        }
        .message {
            margin-bottom: 1rem;
            display: flex;
            align-items: flex-start;
            gap: 10px;
        }
        .message-content {
            padding: 0.75rem 1rem;
            border-radius: 18px;
            max-width: 80%;
        }
        .message.user .message-content {
            background-color: #0d6efd;
            color: white;
            border-bottom-left-radius: 4px;
        }
        .message.agent .message-content {
            background-color: #e9ecef;
            color: #333;
            border-bottom-right-radius: 4px;
        }
        .message.agent {
            justify-content: flex-end;
        }
        .message-icon {
            font-size: 1.5rem;
            padding-top: 0.5rem;
        }
        #agent-input-group {
            border-radius: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }
        #agent-input {
            border-radius: 30px 0 0 30px;
            border: 1px solid #ced4da;
            padding-left: 1.5rem;
        }
        #agent-input:focus {
            box-shadow: none;
            border-color: #0d6efd;
        }
        #agent-submit {
            border-radius: 0 30px 30px 0;
            background-color: #0d6efd;
            border-color: #0d6efd;
        }
        .pulsing {
            animation: pulse 1.5s infinite;
        }
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="main-container">
        <!-- Left Side: Control Panel -->
        <div class="control-panel">
            <h1 class="mb-4">Control Panel</h1>
            <!-- PDF Upload Form -->
            <div class="card">
                <div class="card-header">Upload Document</div>
                <div class="card-body">
                    <form method="post" enctype="multipart/form-data">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="pdf_file" class="form-label small">Select a PDF to process:</label>
                            <input class="form-control" type="file" name="pdf_file" id="pdf_file" accept=".pdf" required>
                        </div>
                        <button type="submit" name="upload_button" class="btn btn-primary w-100">Upload and Ingest</button>
                    </form>
                    {% if messages %}
                        <div class="alert alert-success mt-3 mb-0">
                            {% for message in messages %}{{ message }}{% endfor %}
                        </div>
                    {% endif %}
                </div>
            </div>
            <!-- Standard RAG Form -->
            <div class="card">
                <div class="card-header">Simple Q&A</div>
                <div class="card-body">
                    <form method="post">
                        {% csrf_token %}
                        <div class="mb-3">
                            <label for="document" class="form-label small">Select Document:</label>
                            <select class="form-select" name="document" id="document" required>
                                <option value="">-- Choose a document --</option>
                                {% for doc in ingested_docs %}
                                    <option value="{{ doc }}" {% if doc == last_doc %}selected{% endif %}>{{ doc }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="question" class="form-label small">Your Question:</label>
                            <textarea class="form-control" name="question" id="question" rows="3" required>{{ last_question }}</textarea>
                        </div>
                        <button type="submit" name="query_button" class="btn btn-success w-100">Get Answer</button>
                    </form>
                </div>
            </div>
            {% if show_rag_answer %}
            <div class="card">
                <div class="card-header">Simple Q&A Answer</div>
                <div class="card-body">
                    <p class="small text-muted">Question: <em>{{ last_question }}</em></p>
                    <div class="alert alert-light">{{ answer|linebreaksbr }}</div>
                </div>
            </div>
            {% endif %}
        </div>

        <!-- Right Side: AI Agent Chat -->
        <div class="chat-container">
            <h1 class="mb-4">Conversational AI Agent</h1>
            <div class="card">
                <div class="card-header">Chat History</div>
                <div id="chat-box" class="card-body">
                    <div class="message agent">
                        <i class="fas fa-robot message-icon"></i>
                        <div class="message-content">Hello! I am your document assistant. You can ask me to list available documents, query a specific document, or even compare two documents on a topic.</div>
                    </div>
                </div>
                <div class="card-footer p-3">
                    <div id="agent-input-group" class="input-group">
                        <input type="text" id="agent-input" class="form-control" placeholder="Ask a complex question...">
                        <button id="agent-submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SCRIPT BLOCK -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // ... (The polling script from the previous answer goes here) ...

            // --- ADVANCED AGENT CHAT LOGIC ---
            const agentInput = document.getElementById('agent-input');
            const agentSubmit = document.getElementById('agent-submit');
            const chatBox = document.getElementById('chat-box');
            
            async function handleAgentSubmit() {
                const userInput = agentInput.value.trim();
                if (!userInput) return;

                addMessage(userInput, 'user');
                agentInput.value = '';
                agentInput.disabled = true;
                agentSubmit.disabled = true;

                const thinkingMessage = addMessage("Thinking...", 'agent');
                thinkingMessage.classList.add('pulsing');

                try {
                    const response = await fetch("{% url 'agent_view' %}", {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': '{{ csrf_token }}' },
                        body: JSON.stringify({ user_input: userInput })
                    });

                    if (!response.ok) throw new Error(`Server error: ${response.status}`);
                    
                    const data = await response.json();
                    const agentResponse = data.output;
                    
                    thinkingMessage.classList.remove('pulsing');
                    if (agentResponse) {
                        thinkingMessage.querySelector('.message-content').innerHTML = agentResponse.replace(/\n/g, '<br>');
                    } else {
                        thinkingMessage.querySelector('.message-content').innerText = "I processed the request but didn't have a final answer.";
                    }

                } catch (error) {
                    console.error('Error with agent request:', error);
                    thinkingMessage.classList.remove('pulsing');
                    thinkingMessage.querySelector('.message-content').innerText = "Sorry, a communication error occurred.";
                } finally {
                    agentInput.disabled = false;
                    agentSubmit.disabled = false;
                    agentInput.focus();
                }
            }

            agentSubmit.addEventListener('click', handleAgentSubmit);
            agentInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    handleAgentSubmit();
                }
            });

            function addMessage(text, sender) {
                const messageWrapper = document.createElement('div');
                messageWrapper.classList.add('message', sender);

                const icon = document.createElement('i');
                icon.classList.add('fas', sender === 'user' ? 'fa-user-circle' : 'fa-robot', 'message-icon');
                
                const messageContent = document.createElement('div');
                messageContent.classList.add('message-content');
                messageContent.innerText = text;

                if (sender === 'user') {
                    messageWrapper.appendChild(messageContent);
                    messageWrapper.appendChild(icon);
                } else {
                    messageWrapper.appendChild(icon);
                    messageWrapper.appendChild(messageContent);
                }
                
                chatBox.appendChild(messageWrapper);
                chatBox.scrollTop = chatBox.scrollHeight;
                return messageWrapper;
            }
        });
    </script>
</body>
</html>
